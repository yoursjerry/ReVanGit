name: Watch Upstream ReVanced Releases

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure jq is installed
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

      - name: Determine upstream repo
        id: upstream
        shell: bash
        run: |
          set -euo pipefail

          # 1) UPSTREAM_REPO secret takes priority
          if [ -n "${UPSTREAM_REPO:-}" ]; then
            echo "repo=${UPSTREAM_REPO}" >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          # Safe extraction helper that strips any dangerous characters
          sanitize_repo() {
            echo "$1" \
              | sed -E 's#.*github.com/([^/]+/[^/]+).*#\1#' \
              | sed -E 's#[^A-Za-z0-9._/-]##g'
          }

          # 2) config.json
          if [ -f config.json ]; then
            RAW=$(grep -Eo '"upstream_repo"[[:space:]]*:[[:space:]]*"[^"]+' config.json \
                  | sed -E 's/.*"upstream_repo"[[:space:]]*:[[:space:]]*"//')
            if [ -n "${RAW}" ]; then
              CLEAN=$(sanitize_repo "${RAW}")
              if [ -n "${CLEAN}" ]; then
                echo "repo=${CLEAN}" >> "${GITHUB_OUTPUT}"
                exit 0
              fi
            fi
          fi

          # 3) config.toml
          if [ -f config.toml ]; then
            RAW=$(grep -E 'upstream_repo|upstream|repo' config.toml \
                  | head -n 1 \
                  | sed -E 's/.*=//; s/[ "\"'\'']+//g')

            if echo "${RAW}" | grep -q 'github.com'; then
              CLEAN=$(sanitize_repo "${RAW}")
            else
              CLEAN=$(echo "${RAW}" | sed -E 's#[^A-Za-z0-9._/-]##g')
            fi

            if [ -n "${CLEAN}" ]; then
              echo "repo=${CLEAN}" >> "${GITHUB_OUTPUT}"
              exit 0
            fi
          fi

          # 4) Default fallback
          echo "repo=revanced/revanced-patches" >> "${GITHUB_OUTPUT}"

      - name: Check for Upstream Updates
        id: check
        shell: bash
        run: |
          set -euo pipefail

          REPO="${{ steps.upstream.outputs.repo }}"
          echo "Checking upstream repo: ${REPO}"

          API="https://api.github.com/repos/${REPO}/releases/latest"
          JSON=$(curl -s "${API}" || echo "{}")

          LATEST=$(echo "${JSON}" | jq -r '.tag_name // empty')

          if [ -z "${LATEST}" ]; then
            echo "No valid release found for repo: ${REPO}"
            echo "updated=false" >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          echo "latest=${LATEST}" >> "${GITHUB_OUTPUT}"

          PREVIOUS=""
          if [ -f last_upstream.txt ]; then
            PREVIOUS=$(cat last_upstream.txt || echo "")
          fi

          echo "previous=${PREVIOUS}" >> "${GITHUB_OUTPUT}"

          if [ "${LATEST}" != "${PREVIOUS}" ]; then
            echo "Upstream updated: ${PREVIOUS} â†’ ${LATEST}"
            echo "updated=true" >> "${GITHUB_OUTPUT}"
            echo "${LATEST}" > last_upstream.txt
          else
            echo "No upstream change detected."
            echo "updated=false" >> "${GITHUB_OUTPUT}"
          fi

      - name: Commit Cached Version
        if: steps.check.outputs.updated == 'true'
        shell: bash
        run: |
          git config user.email "github-actions@github.com"
          git config user.name "github-actions"

          git add last_upstream.txt

          # Avoid empty commits
          if ! git diff --cached --quiet; then
            git commit -m "Update upstream version to ${{ steps.check.outputs.latest }}"
            git push
          else
            echo "Nothing changed; skipping commit."
          fi

      - name: Trigger Build Workflow
        if: steps.check.outputs.updated == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            console.log("Dispatching build.yml due to upstream update...");
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "build.yml",
              ref: "main",
              inputs: {
                from_ci: false
              }
            });
            console.log("Build workflow dispatched.");