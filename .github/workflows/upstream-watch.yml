name: CI Check

on:
  workflow_dispatch:
  schedule:
    - cron: "0 16 * * *"   # run daily at 16:00 UTC

jobs:
  check:
    permissions: write-all
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure jq is installed
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

      - name: Check ReVanced Patches pre-release version
        id: upstream
        shell: bash
        run: |
          set -euo pipefail

          echo "Checking ReVanced Patches pre-release..."

          API="https://api.github.com/repos/revanced/revanced-patches/releases?per_page=1"

          LATEST=$(curl -s "${API}" \
            | jq -r 'map(select(.prerelease==true)) | .[0].tag_name // empty')

          if [ -z "${LATEST}" ]; then
            echo "No prerelease found."
            echo "LATEST_TAG=" >> "${GITHUB_OUTPUT}"
          else
            echo "Latest upstream prerelease: ${LATEST}"
            echo "LATEST_TAG=${LATEST}" >> "${GITHUB_OUTPUT}"
          fi

      - name: Load previous upstream tag
        id: previous
        run: |
          if [ -f last_patches_prerelease.txt ]; then
            PREV=$(cat last_patches_prerelease.txt)
            echo "PREVIOUS_TAG=${PREV}" >> "${GITHUB_OUTPUT}"
          else
            echo "PREVIOUS_TAG=" >> "${GITHUB_OUTPUT}"
          fi

      - name: Should build? (Upstream or Config changed)
        id: should_build
        shell: bash
        run: |
          set -euo pipefail

          SHOULD=0
          LATEST="${{ steps.upstream.outputs.LATEST_TAG }}"
          PREVIOUS="${{ steps.previous.outputs.PREVIOUS_TAG }}"

          echo "Latest upstream: '${LATEST}'"
          echo "Previous upstream: '${PREVIOUS}'"

          # 1) Upstream prerelease changed
          if [ -n "${LATEST}" ] && [ "${LATEST}" != "${PREVIOUS}" ]; then
            echo "Upstream prerelease changed!"
            SHOULD=1
            echo "${LATEST}" > last_patches_prerelease.txt
          fi

          # 2) config.toml implicit update check
          UPDATE_CFG=$(./build.sh config.toml --config-update || echo "")

          if [ -n "${UPDATE_CFG}" ]; then
            echo "Config update detected."
            SHOULD=1
            echo "${UPDATE_CFG}" > config.json
          fi

          echo "SHOULD_BUILD=${SHOULD}" >> "${GITHUB_OUTPUT}"

      - name: Clear older runs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh run list -L400 --json databaseId -q '.[].databaseId' \
          | tail -n+10 \
          | xargs -IID gh api "repos/$GITHUB_REPOSITORY/actions/runs/ID" -X DELETE || :

    outputs:
      SHOULD_BUILD: ${{ steps.should_build.outputs.SHOULD_BUILD }}

  run-build:
    needs: check
    if: ${{ needs.check.outputs.SHOULD_BUILD == 1 }}
    uses: ./.github/workflows/build.yml
    permissions: write-all
    secrets: inherit
    with:
      from_ci: true